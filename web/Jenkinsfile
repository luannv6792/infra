pipeline {
  agent any

  environment {
    // üîß DockerHub credentials ID b·∫°n t·∫°o trong Jenkins
    DOCKERHUB_CREDENTIALS = credentials('dockerhub')

    // üîß T√™n image DockerHub (ch·ªânh l·∫°i cho ƒë√∫ng namespace c·ªßa b·∫°n)
    IMAGE_NAME = "luannv67922/infra-web"
  }
  stages {

    stage('Build Docker Image') {
      steps {
        echo "üê≥ Building Docker image ${IMAGE_NAME}:${BUILD_NUMBER}..."
        sh "docker build -t ${IMAGE_NAME}:${BUILD_NUMBER} ."
      }
    }

    stage('Push to DockerHub') {
      steps {
        echo "üì§ Pushing Docker image to DockerHub..."
        script {
          sh """
            echo "${DOCKERHUB_CREDENTIALS_PSW}" | docker login -u "${DOCKERHUB_CREDENTIALS_USR}" --password-stdin
            docker push ${IMAGE_NAME}:${BUILD_NUMBER}
            docker tag ${IMAGE_NAME}:${BUILD_NUMBER} ${IMAGE_NAME}:latest
            docker push ${IMAGE_NAME}:latest
          """
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        echo "üöÄ Deploying to Kubernetes..."
        script {
          sh """
            kubectl set image deployment/infra-web-deployment infra-web=${IMAGE_NAME}:${BUILD_NUMBER} -n app || \
            kubectl apply -f web/infra-web-deployment.yml
          """
        }
      }
    }
  }

  post {
    success {
      echo "‚úÖ Deployment completed successfully!"
    }
    failure {
      echo "‚ùå Deployment failed. Check Jenkins logs for details."
    }
  }
}
