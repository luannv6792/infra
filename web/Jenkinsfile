pipeline {
  agent any

  environment {
    // üîê DockerHub credentials ID trong Jenkins
    DOCKERHUB_CREDENTIALS = 'dockerhub'    // Thay b·∫±ng ID th·∫≠t trong Jenkins Credentials

    // üë§ DockerHub username
    DOCKERHUB_USER = 'luannv67922'           // Thay b·∫±ng username th·∫≠t

    // üè∑Ô∏è Image config
    IMAGE_NAME = 'infraweb'       // T√™n image
    IMAGE_TAG = "latest"          // Tag m·∫∑c ƒë·ªãnh (c√≥ th·ªÉ build theo commit SHA)

    // üß© Kubernetes config
    K8S_NAMESPACE = "app"
    DEPLOYMENT_FILE = "infra/k8s/frontend_deployment.yml"
  }

  options {
    timestamps()
    ansiColor('xterm')
  }

  stages {
    stage('Checkout') {
      steps {
        echo "üîÑ Pulling latest code from Git..."
        checkout scm
      }
    }

    stage('Build Docker Image') {
      steps {
        script {
          echo "üê≥ Building Docker image..."
          sh """
            docker build -t ${DOCKERHUB_USER}/${IMAGE_NAME}:${IMAGE_TAG} infra/web
          """
        }
      }
    }

    stage('Push to DockerHub') {
      steps {
        script {
          echo "üì¶ Pushing image to DockerHub..."
          docker.withRegistry('https://index.docker.io/v1/', "${DOCKERHUB_CREDENTIALS}") {
            sh """
              docker push ${DOCKERHUB_USER}/${IMAGE_NAME}:${IMAGE_TAG}
            """
          }
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        script {
          echo "üöÄ Deploying ${IMAGE_NAME}:${IMAGE_TAG} to namespace ${K8S_NAMESPACE}..."
          sh """
            kubectl apply -f ${DEPLOYMENT_FILE} -n ${K8S_NAMESPACE}
            kubectl rollout restart deployment/${IMAGE_NAME}-deployment -n ${K8S_NAMESPACE} || true
            kubectl get pods -n ${K8S_NAMESPACE}
          """
        }
      }
    }
  }

  post {
    success {
      echo "‚úÖ Deployment successful!"
    }
    failure {
      echo "‚ùå Build or deploy failed. Check logs!"
    }
  }
}
