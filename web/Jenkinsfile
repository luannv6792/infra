pipeline {
  agent any

  environment {
    IMAGE_NAME = "infraweb"
        DOCKERHUB_CREDENTIALS = 'dockerhub'
        DOCKERHUB_USER = 'luannv67922'   // üîÅ thay b·∫±ng user th·∫≠t
        IMAGE_NAME = 'infraweb'
        IMAGE_TAG = "build-${BUILD_NUMBER}"

        // üß© K8s namespace
        K8S_NAMESPACE = "app"
        DEPLOYMENT_FILE = "k8s/backend_deployment.yml"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

        stage('Build Docker image') {
            steps {
                script {
                    echo "üèóÔ∏è Building Docker image..."
                    sh "docker build -t ${DOCKERHUB_USER}/${IMAGE_NAME}:${IMAGE_TAG} -t ${DOCKERHUB_USER}/${IMAGE_NAME}:latest infra/web/."
                }
            }
}


        stage('Push Docker image to DockerHub') {
            steps {
                script {
                    echo "üöÄ Pushing Docker image to DockerHub..."
                    withCredentials([usernamePassword(credentialsId: "${DOCKERHUB_CREDENTIALS}", usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                        sh """
                            echo "$PASS" | docker login -u "$USER" --password-stdin
                            docker push ${DOCKERHUB_USER}/${IMAGE_NAME}:${IMAGE_TAG}
                            docker push ${DOCKERHUB_USER}/${IMAGE_NAME}:latest
                            docker logout
                        """
                    }
                }
            }
        }

    stage('Deploy to Kubernetes') {
      steps {
        sh "kubectl apply -f infra/k8s/frontend_deployment.yml"
        sh "kubectl rollout restart deployment/infra-web -n app"
      }
    }
  }
}
